name: Windows Cloudflared SSH Tunnel (No Token)

on:
  workflow_dispatch:

jobs:
  live-ssh:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install OpenSSH Server
      run: |
        Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'
        netsh advfirewall firewall add rule name="OpenSSH" dir=in action=allow protocol=TCP localport=22

    - name: Install cloudflared
      run: |
        choco install cloudflared -y
        cloudflared --version

    - name: Start Cloudflare Tunnel and generate SSH command
      run: |
        echo "Starting temporary SSH tunnel..."

        # Start the tunnel in foreground and capture the output
        $output = cloudflared tunnel --url ssh://localhost:22 --loglevel info 2>&1

        # Extract hostname and port from log
        if ($output -match 'Forwarding tcp://([a-z0-9.-]+):([0-9]+)') {
            $host = $matches[1]
            $port = $matches[2]
            $user = "Administrator"  # adjust if needed
            Write-Host "====================================================="
            Write-Host "SSH command to connect to this runner:"
            Write-Host "ssh $user@$host -p $port"
            Write-Host "====================================================="
        } else {
            Write-Host "Failed to parse Cloudflare tunnel hostname/port."
        }

        # Keep the tunnel alive
        cloudflared tunnel --url ssh://localhost:22
