name: Self-Hosted Windows WSL + Cloudflare SSH

on:
  workflow_dispatch:

jobs:
  wsl-cloudflare-ssh:
    runs-on: self-hosted

    steps:
    - name: Enable WSL and install Ubuntu 24.04
      run: |
        dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
        dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

        wsl --set-default-version 2
        wsl --install -d Ubuntu-24.04

        Write-Host "Rebooting machine to complete WSL installation..."
        Restart-Computer -Force

    - name: Install SSH and Cloudflared inside WSL
      run: |
        wsl -d Ubuntu-24.04 -- bash -c "
          sudo apt-get update
          sudo apt-get install -y openssh-server curl

          # Start SSH server
          sudo service ssh start

          # Install Cloudflared
          curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb -o cloudflared.deb
          sudo dpkg -i cloudflared.deb
        "

    - name: Start Cloudflare SSH tunnel
      run: |
        wsl -d Ubuntu-24.04 -- bash -c "
          echo 'Starting Cloudflare Tunnel for SSH...'

          # Run Cloudflare Tunnel in foreground and capture hostname/port
          output=\$(cloudflared tunnel --url ssh://localhost:22 --loglevel info 2>&1)

          # Extract hostname and port
          if [[ \$output =~ Forwarding\ tcp://([a-z0-9.-]+):([0-9]+) ]]; then
            host=\${BASH_REMATCH[1]}
            port=\${BASH_REMATCH[2]}
            user=\$(whoami)
            echo '================ SSH CONNECTION INFO ================'
            echo 'SSH command:'
            echo \"ssh \$user@\$host -p \$port\"
            echo '====================================================='
          else
            echo 'Failed to parse Cloudflare tunnel hostname/port.'
          fi

          # Keep tunnel alive
          cloudflared tunnel --url ssh://localhost:22
        "

    - name: Test X11 GUI (optional)
      run: |
        wsl -d Ubuntu-24.04 -- bash -c "sudo apt-get install -y x11-apps mesa-utils; xclock &"
