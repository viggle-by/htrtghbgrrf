name: Windows SSH via Cloudflare

on:
  workflow_dispatch:

jobs:
  windows-ssh-cloudflare:
    runs-on: self-hosted
    # Make sure the runner is Windows

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable OpenSSH Server on Windows
      run: |
        # Enable and start OpenSSH Server
        Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'

        # Allow SSH through Windows Firewall
        New-NetFirewallRule -Name sshd -DisplayName 'OpenSSH Server' -Enabled True -Direction Inbound -Protocol TCP -Action Allow -LocalPort 22

    - name: Install Cloudflared
      run: |
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$env:ProgramFiles\cloudflared.exe"

    - name: Start Cloudflare SSH tunnel
      run: |
        # Start Cloudflare tunnel to local SSH
        Start-Process -FilePath "$env:ProgramFiles\cloudflared.exe" -ArgumentList "tunnel --url ssh://localhost:22" -NoNewWindow

        # Give it a few seconds to initialize
        Start-Sleep -Seconds 5

        # Retrieve public hostname/port from log
        Write-Host "================ SSH CONNECTION INFO ================"
        Write-Host "Use Cloudflare tunnel to connect to this Windows machine via SSH"
        Write-Host "ssh <username>@<hostname_provided_by_cloudflared> -p <port>"
        Write-Host "====================================================="
        
        # Keep the job alive
        while ($true) { Start-Sleep -Seconds 60 }
