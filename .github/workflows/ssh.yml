name: WSL Ubuntu 24.04 with tmate and X11

on:
  workflow_dispatch:

jobs:
  wsl-tmate-x11:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Enable WSL and install Ubuntu 24.04
      run: |
        # Enable WSL and Virtual Machine Platform
        dism.exe /online /enable-feature /featurename:Microsoft-Windows-Subsystem-Linux /all /norestart
        dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart

        # Install Ubuntu 24.04
        wsl --install -d Ubuntu-24.04

        # Set default WSL version to 2
        wsl --set-default-version 2

    - name: Update Ubuntu and install tmate + GUI tools
      run: |
        wsl -d Ubuntu-24.04 -- bash -c "
          sudo apt-get update
          sudo apt-get install -y tmate x11-apps dbus-x11 mesa-utils
        "

    - name: Start tmate session inside WSL
      run: |
        wsl -d Ubuntu-24.04 -- bash -c "
          # Start a new tmate session in foreground
          tmate -S /tmp/tmate.sock new-session -d
          
          # Print SSH and web connection info
          tmate -S /tmp/tmate.sock display -p '#{tmate_ssh}'
          tmate -S /tmp/tmate.sock display -p '#{tmate_web}'

          # Keep session alive
          tmate -S /tmp/tmate.sock attach
        "

    - name: Test X11 GUI (optional)
      run: |
        # Run xclock or any GUI app to test WSLg forwarding
        wsl -d Ubuntu-24.04 -- bash -c "sudo apt install neofetch"
