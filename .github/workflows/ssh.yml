name: Windows Cloudflared SSH Tunnel

on:
  workflow_dispatch:

jobs:
  live-access:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install OpenSSH Server (if needed)
      run: |
        Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0
        Start-Service sshd
        Set-Service -Name sshd -StartupType 'Automatic'
        netsh advfirewall firewall add rule name="OpenSSH" dir=in action=allow protocol=TCP localport=22

    - name: Install cloudflared
      run: |
        choco install cloudflared -y
        cloudflared --version

    - name: Start cloudflared tunnel for SSH
      env:
        CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
      run: |
        # Authenticate with Cloudflare
        cloudflared tunnel login --token $env:CLOUDFLARED_TOKEN

        # Create and run a temporary tunnel exposing port 22 (SSH)
        Start-Process -NoNewWindow -FilePath "cloudflared.exe" -ArgumentList "tunnel --url ssh://localhost:22"
